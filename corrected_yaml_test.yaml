name: Automazione di gestione email con sentiment negativo e chiamata ElevenLabs
start_state: email_listener
listener:
  listener_type: email-listener
states:
  email_listener:
    state_type: email-listener
    server: '{IMAP_SERVER}'
    port: 993
    username: '{IMAP_USERNAME}'
    password: '{IMAP_PASSWORD}'
    folder: INBOX
    poll_interval: 300
    output:
      email_text: email_body
      email_subject: email_subject
      email_from: email_from
    log: "üìß Nuova email ricevuta da {email_from}: {email_subject}"
    transition: analyze_sentiment
  analyze_sentiment:
    state_type: llm_agent
    provider: openai
    model: gpt-4
    api_key: '{OPENAI_API_KEY}'
    temperature: 0.3
    max_tokens: 100
    system_prompt: >
      Sei un analista di sentiment. Indica se il sentiment del testo √® negativo,
      neutro o positivo con una sola parola.
    user_prompt: |
      Analizza il sentiment del seguente testo:
      """
      {email_text}
      """
    output: sentiment_result
    response_key: sentiment
    log: "ü§ñ Analisi sentiment in corso per email da {email_from}"
    transition: check_negative_sentiment
  check_negative_sentiment:
    state_type: if
    condition: sentiment_result.lower() == 'negativo'
    log: "üîç Verifico se il sentiment √® negativo: {sentiment_result}"
    transition_true: extract_phone_number
    transition_false: end
  extract_phone_number:
    state_type: llm_agent
    provider: openai
    model: gpt-4
    api_key: '{OPENAI_API_KEY}'
    temperature: 0
    max_tokens: 50
    system_prompt: >
      Sei un estrattore di numeri di telefono. Estrai il numero di telefono dal
      testo fornito.

      Restituisci solo il numero.
    user_prompt: |
      Estrai il numero di telefono dal seguente testo:
      """
      {email_text}
      """
    output: extracted_phone
    response_key: phone_number
    log: "üì± Estrazione numero di telefono dal testo email"
    transition: check_phone_number
  check_phone_number:
    state_type: if
    condition: >-
      extracted_phone.phone_number is not none and extracted_phone.phone_number
      != ''
    log: "üîç Verifico presenza numero di telefono estratto"
    transition_true: batch_call_elevenlabs
    transition_false: end
  batch_call_elevenlabs:
    state_type: elevenlabs_batch_calling
    operation: submit
    api_key: '{ELEVENLABS_API_KEY}'
    call_name: Chiamata di follow-up
    agent_id: '{ELEVENLABS_AGENT_ID}'
    agent_phone_number_id: '{ELEVENLABS_AGENT_PHONE_ID}'
    recipients:
      - phone_number: '{extracted_phone.phone_number}'
        contact_info:
          name: Utente
    message: Abbiamo notato un feedback negativo. Desideri parlare con un operatore?
    output: batch_call_result
    log: "‚òéÔ∏è Avvio chiamata automatica ElevenLabs al numero {extracted_phone.phone_number}"
    transition: end
  end:
    state_type: end